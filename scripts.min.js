/**
 * Óptima Digital - Lógica Principal da Aplicação
 * Versão: 1.1.0
 * Descrição: Gerencia PWA, animações de scroll, typewriter multi-palavras, 
 * consentimento de cookies e envio do formulário de contato.
 */

(() => {
  // Funções Utilitárias: Seletores e Auxiliares de DOM
  var f = (n, e = document) => e.querySelectorAll(n), i = n => document.getElementById(n);
  var d = (n, e, t) => { n && n.classList.toggle(e, t) };
  var r = (n, e, t, s) => {
    if (!n) return () => { };
    if (typeof t == "string" && s) {
      let c = t, a = l => { let m = l.target.closest(c); m && s.call(m, l) };
      return n.addEventListener(e, a), () => n.removeEventListener(e, a)
    }
    let o = t; return n.addEventListener(e, o), () => n.removeEventListener(e, o)
  };

  // Gerenciamento de Estado e LocalStorage
  var h = new (class {
    constructor(e = "app_") { this.prefix = e }
    get(e, t = null) { try { let s = localStorage.getItem(this.prefix + e); return s ? JSON.parse(s) : t } catch (s) { return t } }
    set(e, t) { try { return localStorage.setItem(this.prefix + e, JSON.stringify(t)), !0 } catch (s) { return !1 } }
  });

  // Componentes de UI: Gerenciador de Alternância de Tema
  var x = "theme", E = "light-mode", A = { light: "moon", dark: "sun" }, p = class {
    constructor(e = {}) { this.config = { toggleIds: ["theme-toggle", "theme-toggle-header"], defaultTheme: "dark", ...e }, this.elements = { toggles: this.config.toggleIds.map(i).filter(Boolean), body: document.body, html: document.documentElement }, this.init() } init() { let e = h.get(x, this.config.defaultTheme); this.setTheme(e), this.attachEvents() } attachEvents() { this.elements.toggles.forEach(e => { r(e, "click", () => this.toggle()) }) } getCurrentTheme() { return this.elements.body.classList.contains(E) ? "light" : "dark" } setTheme(e) { let t = e === "light";[this.elements.body, this.elements.html].forEach(s => { d(s, E, t) }), this.updateToggleButtons(e), h.set(x, e), this.refreshIcons() } toggle() { let e = this.getCurrentTheme() === "light" ? "dark" : "light"; this.setTheme(e) } updateToggleButtons(e) { let t = A[e], s = e === "light" ? "Modo escuro" : "Modo claro"; this.elements.toggles.forEach((o, c) => { let a = c > 0; o.innerHTML = `<i data-lucide="${t}"${a ? ' class="w-4 h-4"' : ""}></i>`, o.setAttribute("aria-label", s) }) } refreshIcons() { try { window.lucide?.createIcons?.({ icons: window.lucide?.icons }) } catch (e) { console.warn("Lucide icons refresh failed:", e) } }
  }; var v = "cookiePreferences", $ = "G-11RH8STBFW", u = class { constructor(e = {}) { this.config = { delay: 1500, ...e }, this.elements = { banner: i("cookie-banner"), modal: i("cookie-modal"), acceptBtn: i("cookie-accept"), rejectBtn: i("cookie-reject"), customizeBtn: i("cookie-customize"), saveBtn: i("cookie-save-preferences"), closeBtn: i("cookie-modal-close"), checkboxes: { analytics: i("cookie-analytics"), marketing: i("cookie-marketing"), functional: i("cookie-functional") } }, this.init() } init() { let e = this.getPreferences(); e ? this.applyPreferences(e) : setTimeout(() => this.showBanner(), this.config.delay), this.attachEvents() } attachEvents() { let { acceptBtn: e, rejectBtn: t, customizeBtn: s, saveBtn: o, closeBtn: c, modal: a } = this.elements; r(e, "click", () => this.acceptAll()), r(t, "click", () => this.rejectAll()), r(s, "click", () => this.openModal()), r(o, "click", () => this.savePreferences()), r(c, "click", () => this.closeModal()), r(a, "click", l => { l.target === a && (this.closeModal(), this.getPreferences() || this.showBanner()) }) } getPreferences() { return h.get(v) } savePreferencesData(e) { let t = { ...e, timestamp: new Date().toISOString() }; h.set(v, t), this.applyPreferences(t) } applyPreferences(e) { window[`ga-disable-${$}`] = !e.analytics } acceptAll() { this.savePreferencesData({ essential: !0, analytics: !0, marketing: !0, functional: !0 }), this.hideBanner(), this.closeModal() } rejectAll() { this.savePreferencesData({ essential: !0, analytics: !1, marketing: !1, functional: !1 }), this.hideBanner(), this.closeModal() } savePreferences() { let { checkboxes: e } = this.elements; this.savePreferencesData({ essential: !0, analytics: e.analytics?.checked || !1, marketing: e.marketing?.checked || !1, functional: e.functional?.checked || !1 }), this.closeModal() } openModal() { let e = this.getPreferences(), { checkboxes: t, modal: s } = this.elements; e && (t.analytics && (t.analytics.checked = e.analytics), t.marketing && (t.marketing.checked = e.marketing), t.functional && (t.functional.checked = e.functional)), s?.classList.add("show"), document.body.style.overflow = "hidden", this.hideBanner() } closeModal() { this.elements.modal?.classList.remove("show"), document.body.style.overflow = "" } showBanner() { this.elements.banner?.classList.add("show") } hideBanner() { this.elements.banner?.classList.remove("show") } static checkConsent(e) { return h.get(v)?.[e] || !1 } }, G = u.checkConsent; var T = n => { let e = n.replace(/\D/g, "").slice(0, 11); return e.length > 6 ? `(${e.slice(0, 2)}) ${e.slice(2, 7)}-${e.slice(7)}` : e.length > 2 ? `(${e.slice(0, 2)}) ${e.slice(2)}` : e.length > 0 ? `(${e}` : "" }; var L = n => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n), I = n => { let e = n.replace(/\D/g, ""); return e.length >= 10 && e.length <= 11 }, S = n => n?.trim().length > 0; var g = class {
    constructor() { this.init() } init() { this.theme = new p, this.cookies = new u, this.initMobileMenu(), this.initScrollAnimations(), this.initCounters(), this.initFAQ(), this.initScrollToTop(), this.initParallax(), this.initForm(), this.initPhoneMask(), this.initCTATracking(), this.refreshIcons() } initMobileMenu() { let e = i("mobile-menu-button"), t = i("mobile-menu"); if (!e || !t) return; let s = () => t.classList.remove("open"); r(e, "click", o => { o.stopPropagation(), t.classList.toggle("open") }), f("#mobile-menu a").forEach(o => r(o, "click", s)), r(document, "click", o => { t.classList.contains("open") && !t.contains(o.target) && !e.contains(o.target) && s() }), r(document, "keydown", o => o.key === "Escape" && s()) } initScrollAnimations() { let e = (t, s, o = {}) => { let c = new IntersectionObserver(a => { a.forEach(l => { l.isIntersecting && (l.target.classList.add(s), c.unobserve(l.target)) }) }, { threshold: .1, ...o }); f(t).forEach(a => c.observe(a)) }; e(".animate-on-scroll", "is-visible"), e(".stagger-item", "is-visible", { rootMargin: "-50px" }), e(".text-reveal, .text-slide, .text-reveal-letter", "revealed", { threshold: .3 }) } initCounters() { let e = s => 1 - Math.pow(2, -10 * s), t = s => s.toLocaleString("pt-BR"); f(".counter").forEach(s => { new IntersectionObserver(([c]) => { if (!c.isIntersecting) return; let a = +s.dataset.target, l = s.dataset.suffix || "", m = performance.now(), C = 2500, w = M => { let B = M - m, b = Math.min(B / C, 1), P = Math.floor(a * e(b)); s.textContent = t(P) + l, b < 1 && requestAnimationFrame(w) }; requestAnimationFrame(w) }, { threshold: .5 }).observe(s) }) } initFAQ() { r(document, "click", ".faq-question", e => { let t = e.target.closest(".faq-item"), s = t.classList.contains("open"); f(".faq-item.open").forEach(o => o.classList.remove("open")), s || t.classList.add("open") }) } initScrollToTop() { let e = i("back-to-top-btn"); e && (r(window, "scroll", k(() => { d(e, "show", window.scrollY > 300) }, 100)), r(e, "click", () => { window.scrollTo({ top: 0, behavior: "smooth" }) })) } initParallax() { let e = document.querySelector(".section-background"); e && r(window, "scroll", k(() => { e.style.backgroundPositionY = `${window.scrollY * .5}px` }, 10)) } initForm() {
      let e = i("contact-form");
      if (!e) return;

      const showToast = (message, isError = false) => {
        const toast = i("form-toast");
        const toastMsg = i("toast-message");
        if (!toast || !toastMsg) return;

        toastMsg.textContent = message;
        toast.className = `fixed bottom-24 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 ${isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`;
        toast.style.opacity = "1";
        toast.style.transform = "translate(-50%, 0)";

        setTimeout(() => {
          toast.style.opacity = "0";
          toast.style.transform = "translate(-50%, 1rem)";
        }, 5000);
      };

      r(e, "submit", async t => {
        t.preventDefault();
        let s = new FormData(e), o = Object.fromEntries(s);
        if (!S(o.name) || !L(o.email) || !I(o.whatsapp)) {
          showToast("Por favor, preencha todos os campos corretamente.", true);
          return;
        }

        const btn = i("submit-btn");
        const btnText = i("btn-text");
        const btnLoading = i("btn-loading");

        if (btn) btn.disabled = true;
        if (btnText) btnText.classList.add("hidden");
        if (btnLoading) btnLoading.classList.remove("hidden");

        o.timestamp = new Date().toISOString();
        o.page_url = window.location.href;

        try {
          const response = await fetch("https://api.web3forms.com/submit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(o)
          });

          if (response.ok) {
            showToast("Mensagem enviada com sucesso!");
            e.reset();
          } else {
            throw new Error("Erro no envio");
          }
        } catch (c) {
          showToast("Erro ao enviar mensagem. Tente novamente.", true);
          console.error("Form submission error:", c);
        } finally {
          if (btn) btn.disabled = false;
          if (btnText) btnText.classList.remove("hidden");
          if (btnLoading) btnLoading.classList.add("hidden");
        }
      });
    }
    initPhoneMask() { r(document, "input", "#whatsapp", e => { e.target.value = T(e.target.value) }) } initCTATracking() { f('a[href="#contact"]').forEach(e => { r(e, "click", () => { typeof trackEvent == "function" && trackEvent("cta_click", { event_category: "engagement", event_label: e.textContent.trim() }) }) }) } refreshIcons() { try { window.lucide?.createIcons?.({ icons: window.lucide?.icons }) } catch (e) { console.warn("Lucide icons initialization failed:", e) } }
  };

  // Inicialização da App quando o DOM estiver pronto
  document.readyState === "loading" ? document.addEventListener("DOMContentLoaded", () => new g) : new g;

  // Typewriter Infinito Unificado (Título Principal)
  (function () {
    const el = i("marketing-typewriter");
    if (!el) return;

    const words = ["Marketing Digital", "Automação com IA", "Tráfego Pago", "Design Premium", "Escalabilidade"];
    let wordIndex = 0;
    let charIndex = 0;
    let isDeleting = false;
    let typeSpeed = 150;

    function type() {
      const currentWord = words[wordIndex];

      if (isDeleting) {
        el.textContent = currentWord.substring(0, charIndex--);
        typeSpeed = 60;
      } else {
        el.textContent = currentWord.substring(0, charIndex++);
        typeSpeed = 150;
      }

      if (!isDeleting && charIndex > currentWord.length) {
        isDeleting = true;
        typeSpeed = 2000; // Pause at top
      } else if (isDeleting && charIndex < 0) {
        isDeleting = false;
        wordIndex = (wordIndex + 1) % words.length;
        charIndex = 0;
        typeSpeed = 500; // Pause before next word
      }

      setTimeout(type, typeSpeed);
    }

    type();
  })();

  // Typewriter Secundário (Sub-header)
  (function () {
    const el = i("typewriter");
    if (!el) return;

    const phrases = [
      "Gestão de redes sociais e tráfego pago com resultados.",
      "Estratégias personalizadas para o seu negócio escalar.",
      "Transformamos cliques em clientes fiéis através de tecnologia."
    ];
    let index = 0;
    let char = 0;
    let deleting = false;

    function step() {
      const text = phrases[index];
      el.textContent = deleting ? text.substring(0, char--) : text.substring(0, char++);

      let speed = deleting ? 40 : 100;
      if (!deleting && char > text.length) {
        deleting = true;
        speed = 4000; // Pause longer to allow reading
      } else if (deleting && char < 0) {
        deleting = false;
        index = (index + 1) % phrases.length;
        char = 0;
        speed = 800;
      }
      setTimeout(step, speed);
    }
    step();
  })();

  // Smoke Cursor Effect
  (function () {
    if (document.getElementById('smoke-cursor')) return;
    var cursor = document.createElement('div');
    cursor.id = 'smoke-cursor';
    cursor.className = 'smoke-cursor';
    document.body.appendChild(cursor);
    var lastX = 0, lastY = 0;
    document.addEventListener('mousemove', function (e) {
      lastX = e.clientX - 16;
      lastY = e.clientY - 16;
      cursor.style.transform = 'translate(' + lastX + 'px,' + lastY + 'px)';
      cursor.classList.remove('smoke');
      void cursor.offsetWidth;
      cursor.classList.add('smoke');
    });
  })();
})();
